# ๐๏ธ ะขะะฅะะะงะะกะะะ ะะะะะะะ
## ะะตะฐะปะธะทะฐัะธั ะณะพะปะพัะพะฒะพะณะพ ะฒะฒะพะดะฐ ะฒ ัะตะถะธะผะต ะดะธะฐะปะพะณะฐ

**ะะฐัะฐ ัะพะทะดะฐะฝะธั:** 2025-12-20  
**ะกัะฐััั:** ะ ัะฐะทัะฐะฑะพัะบะต  
**ะะตััะธั:** 1.0  
**ะัะธะพัะธัะตั:** ะััะพะบะธะน  

---

## 1. ะะะะะะงะะะะ ะ ะะะะะกะขะฌ ะะะะะะะะะะฏ

### 1.1 ะะฐะทะฝะฐัะตะฝะธะต
ะะฐััะธัะธัั ััะฝะบัะธะพะฝะฐะปัะฝะพััั ัะตะถะธะผะฐ ะดะธะฐะปะพะณะฐ (`/chat`) ะดะปั ะพะฑัะฐะฑะพัะบะธ ะณะพะปะพัะพะฒัั ัะพะพะฑัะตะฝะธะน ะฟะฐัะฐะปะปะตะปัะฝะพ ั ัะตะบััะพะฒัะผ ะฒะฒะพะดะพะผ.

### 1.2 ะะฑะปะฐััั ะฟัะธะผะตะฝะตะฝะธั
- **ะะตะถะธะผ:** `/chat` (ะดะธะฐะปะพะณ)
- **ะัะพะดะฝัะต ะดะฐะฝะฝัะต:** ะะพะปะพัะพะฒัะต ัะพะพะฑัะตะฝะธั Telegram (voice)
- **ะััะพะดะฝัะต ะดะฐะฝะฝัะต:** ะขะตะบััะพะฒัะน ะพัะฒะตั ะะ ะฒ ัะฐั
- **ะะปะฐััะพัะผะฐ:** Telegram ะฑะพั ะฝะฐ Python (aiogram)

### 1.3 ะฆะตะปะตะฒัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ
- ะะพะฝะตัะฝัะต ะฟะพะปัะทะพะฒะฐัะตะปะธ Telegram ะฑะพัะฐ
- ะขะต, ะบัะพ ะธัะฟะพะปัะทัะตั `/chat` ะดะปั ะพะฑัะตะฝะธั

---

## 2. ะะะะกะะะะ ะะะจะะะะฏ

### 2.1 ะขะตะบััะตะต ัะพััะพัะฝะธะต
```
ะะพะปัะทะพะฒะฐัะตะปั โ /chat โ ะะธัะตั ัะตะบัั โ ะะพั ะพะฑัะฐะฑะฐััะฒะฐะตั โ ะัะฒะตั
```

### 2.2 ะขัะตะฑัะตะผะพะต ัะพััะพัะฝะธะต
```
ะะพะปัะทะพะฒะฐัะตะปั โ /chat โ โโ ะะธัะตั ัะตะบัั โ ะะฑัะฐะฑะพัะบะฐ ัะตะบััะฐ
                        โโ ะัะฟัะฐะฒะปัะตั ะณะพะปะพั โ ะะฐััะธััะพะฒะบะฐ (Whisper) โ 
                                             ะะฑัะฐะฑะพัะบะฐ ัะตะบััะฐ โ 
                                             ะัะฒะตั ะะ โ 
                                             ะัะฒะพะด ะฒ ัะฐั
```

### 2.3 ะััะธัะตะบัััะฐ ัะตัะตะฝะธั

**Pipeline ะพะฑัะฐะฑะพัะบะธ ะณะพะปะพัะฐ:**

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  TELEGRAM BOT (aiogram)                                     โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ                                                             โ
โ  Voice Message โโโ โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                   โ ะกะบะฐัะธะฒะฐะฝะธะต ะณะพะปะพัะพะฒะพะณะพ ัะฐะนะปะฐ        โ  โ
โ                   โ (bot.download_file)                โ  โ
โ                   โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                โ                         โ
โ                                โผ                         โ
โ                   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                   โ ะัะฟัะฐะฒะบะฐ ะฒ OpenAI Whisper API      โ  โ
โ                   โ (ัะฐััะธััะพะฒะบะฐ ะฐัะดะธะพ โ ัะตะบัั)        โ  โ
โ                   โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                โ                         โ
โ                                โผ                         โ
โ                   โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                   โ ะะพะปััะตะฝะธะต ัะตะบััะฐ ัะฐััะธััะพะฒะบะธ       โ  โ
โ                   โโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                โ                         โ
โ                                โผ                         โ
โ      โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ      โ ะะะะะะฏ ะะะะะะะขะะ ะขะะะกะขะ                      โ    โ
โ      โ (ะบะฐะบ ะดะปั ัััะฝะพะณะพ ะฒะฒะพะดะฐ)                     โ    โ
โ      โ                                              โ    โ
โ      โ โโ ะัะพะฒะตัะบะฐ ะฒะฐะปะธะดะฐัะธะธ                       โ    โ
โ      โ โโ ะะฐะณััะทะบะฐ chat_system ะฟัะพะผะฟัะฐ             โ    โ
โ      โ โโ ะะฐะฟัะพั ะฒ LLM (GPT/Claude)                โ    โ
โ      โ โโ ะะพะปััะตะฝะธะต ะพัะฒะตัะฐ                        โ    โ
โ      โโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ                         โ                                โ
โ                         โผ                                โ
โ      โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ      โ ะะขะะะะะะ ะะขะะะขะ ะ TELEGRAM                   โ    โ
โ      โ (ะบะฐะบ ะดะปั ัะตะบััะพะฒะพะณะพ ัะตะถะธะผะฐ)                 โ    โ
โ      โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ    โ
โ                                                         โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

---

## 3. ะขะะะะะะะะะฏ

### 3.1 ะคัะฝะบัะธะพะฝะฐะปัะฝัะต ััะตะฑะพะฒะฐะฝะธั

#### FR-1: ะะฑัะฐะฑะพัะบะฐ ะณะพะปะพัะพะฒัั ัะพะพะฑัะตะฝะธะน
**ะะฟะธัะฐะฝะธะต:** ะะพั ะดะพะปะถะตะฝ ะฟัะธะฝะธะผะฐัั ะณะพะปะพัะพะฒัะต ัะพะพะฑัะตะฝะธั ะฒ ัะตะถะธะผะต `/chat`

**ะฃัะปะพะฒะธั:**
- ะขะธะฟ ัะพะพะฑัะตะฝะธั: `Message.voice` (Telegram)
- ะคะพัะผะฐัั: OGG (Opus) - ััะฐะฝะดะฐััะฝัะน Telegram
- ะะฐะทะผะตั: ะดะพ 20 MB (ะพะณัะฐะฝะธัะตะฝะธะต Telegram)

**ะัะธัะตัะธะธ ะฟัะธะตะผะบะธ:**
- โ ะะพะปะพั ะทะฐะณััะถะฐะตััั ะฑะตะท ะพัะธะฑะพะบ
- โ ะคะฐะนะป ัะพััะฐะฝัะตััั ะฒะพ ะฒัะตะผะตะฝะฝัั ะฟะฐะฟะบั
- โ ะะพะณะธััะตััั ัะฐะบั ะฟะพะปััะตะฝะธั

#### FR-2: ะะฐััะธััะพะฒะบะฐ ะณะพะปะพัะฐ ะฒ ัะตะบัั
**ะะฟะธัะฐะฝะธะต:** ะัะฟะพะปัะทะพะฒะฐะฝะธะต OpenAI Whisper API ะดะปั ััะฐะฝัะบัะธะฟัะธะธ

**ะกะตัะฒะธั:** OpenAI Whisper API
- **ะะพะดะตะปั:** `whisper-1`
- **ะฏะทัะบ:** ะะฒัะพะพะฟัะตะดะตะปะตะฝะธะต (ัะฐะฑะพัะฐะตั ะดะปั ััััะบะพะณะพ, ะฐะฝะณะปะธะนัะบะพะณะพ ะธ ั.ะด.)
- **ะะณัะฐะฝะธัะตะฝะธั:** ัะฐะนะป โค 25 MB, 25 ะทะฐะฟัะพัะพะฒ/ัะตะบ

**ะฃัะปะพะฒะธั:**
- ะะฐััะธััะพะฒะบะฐ ะดะพะปะถะฝะฐ ัะฐะฑะพัะฐัั ะบะพััะตะบัะฝะพ
- ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ ะฟัะธ ะฝะตะดะพัััะฟะฝะพััะธ API
- ะขะฐะนะผะฐัั: 60 ัะตะบัะฝะด

**ะัะธัะตัะธะธ ะฟัะธะตะผะบะธ:**
- โ ะะพะปะพั ัะฐััะธััะพะฒัะฒะฐะตััั ะฒ ัะตะบัั
- โ ะะพะดะดะตัะถะบะฐ ััััะบะพะณะพ ัะทัะบะฐ
- โ ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ API (ัะตัั, ะปะธะผะธั, timeout)

#### FR-3: ะะดะธะฝะฐั ะพะฑัะฐะฑะพัะบะฐ ัะตะบััะฐ
**ะะฟะธัะฐะฝะธะต:** ะะฐััะธััะพะฒะฐะฝะฝัะน ัะตะบัั ะดะพะปะถะตะฝ ะพะฑัะฐะฑะฐััะฒะฐัััั ะบะฐะบ ะพะฑััะฝัะน ัะตะบััะพะฒัะน ะฒะฒะพะด

**ะฃัะปะพะฒะธั:**
- ะัะฟะพะปัะทะพะฒะฐะฝะธะต ัะพะณะพ ะถะต ะบะพะฝะฒะตะนะตัะฐ ะพะฑัะฐะฑะพัะบะธ, ััะพ ะธ ะฒ ัะตะบััะพะฒะพะผ ัะตะถะธะผะต
- ะะฐะณััะทะบะฐ custom `chat_system` ะฟัะพะผะฟัะฐ ะธะท PromptManager
- ะะฐะฟัะพั ะฒ LLM (OpenAI/Replicate)
- ะะฑัะฐะฑะพัะบะฐ ะดะปะธะฝะฝัั ะพัะฒะตัะพะฒ (splitting)

**ะัะธัะตัะธะธ ะฟัะธะตะผะบะธ:**
- โ ะขะตะบัั ะพะฑัะฐะฑะฐััะฒะฐะตััั ะบะฐะบ ChatStates.chatting
- โ ะัะฟะพะปัะทัะตััั ัะตะบััะธะน chat_system ะฟัะพะผะฟั
- โ ะัะฒะตั ะบะพััะตะบัะตะฝ ะธ ัะพะดะตัะถะธั ะธะฝัะพัะผะฐัะธั

#### FR-4: ะัะฒะพะด ะพัะฒะตัะฐ ะฒ ัะฐั
**ะะฟะธัะฐะฝะธะต:** ะัะฒะตั ะะ ะพัะฟัะฐะฒะปัะตััั ะฟะพะปัะทะพะฒะฐัะตะปั

**ะฃัะปะพะฒะธั:**
- ะัะฒะพะด ะธะดะตะฝัะธัะตะฝ ัะตะบััะพะฒะพะผั ัะตะถะธะผั
- ะะพะดะดะตัะถะบะฐ Markdown
- ะะฐะทะฑะธะตะฝะธะต ะฝะฐ ัะฐััะธ (4000 ัะธะผะฒะพะปะพะฒ ะผะฐะบั)
- ะะฝะดะธะบะฐัะพั "ะฟะตัะฐัะฐะตั" (typing indicator)

**ะัะธัะตัะธะธ ะฟัะธะตะผะบะธ:**
- โ ะัะฒะตั ะฒัะฒะพะดะธััั ะฒ ัะฐั
- โ ะคะพัะผะฐัะธัะพะฒะฐะฝะธะต ัะพััะฐะฝะตะฝะพ
- โ ะะปะธะฝะฝัะต ะพัะฒะตัั ัะฐะทะฑะธะฒะฐัััั ะบะพััะตะบัะฝะพ

### 3.2 ะะตััะฝะบัะธะพะฝะฐะปัะฝัะต ััะตะฑะพะฒะฐะฝะธั

#### NFR-1: ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั
- **ะกะบะพัะพััั ัะฐััะธััะพะฒะบะธ:** < 30 ัะตะบัะฝะด ะดะปั 60-ัะตะบัะฝะดะฝะพะณะพ ะณะพะปะพัะฐ
- **ะัะตะผั ะพะฑัะฐะฑะพัะบะธ:** < 5 ัะตะบัะฝะด (ะฑะตะท ััะตัะฐ LLM)
- **ะขะฐะนะผะฐัั ะฝะฐ ัะบะฐัะธะฒะฐะฝะธะต:** 60 ัะตะบ
- **ะขะฐะนะผะฐัั ะฝะฐ Whisper:** 60 ัะตะบ

#### NFR-2: ะะฐะดะตะถะฝะพััั
- **ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ:** ะัะต ะธัะบะปััะตะฝะธั ะดะพะปะถะฝั ะฑััั ะฟะตัะตัะฒะฐัะตะฝั
- **ะะพัััะฐะฝะพะฒะปะตะฝะธะต:** Graceful degradation ะฟัะธ ะพัะธะฑะบะต API
- **Retry logic:** 3 ะฟะพะฟััะบะธ ะดะปั Whisper ะฟัะธ ัะตัะตะฒัั ะพัะธะฑะบะฐั

#### NFR-3: ะะตะทะพะฟะฐัะฝะพััั
- **ะะฐะปะธะดะฐัะธั:** ะัะพะฒะตัะบะฐ ัะฐะทะผะตัะฐ ัะฐะนะปะฐ ะฟะตัะตะด ะพัะฟัะฐะฒะบะพะน ะฒ Whisper
- **ะฃะดะฐะปะตะฝะธะต ัะฐะนะปะพะฒ:** ะัะตะผะตะฝะฝัะต ัะฐะนะปั ัะดะฐะปััััั ะฟะพัะปะต ะพะฑัะฐะฑะพัะบะธ
- **ะะพะณะธัะพะฒะฐะฝะธะต:** ะะพะณะธัััััั ัะพะปัะบะพ ะผะตัะฐะดะฐะฝะฝัะต (ัะฐะทะผะตั, ะฒัะตะผั), ะฝะต ัะพะดะตัะถะธะผะพะต

#### NFR-4: ะะฐัััะฐะฑะธััะตะผะพััั
- **ะะฐัะฐะปะปะตะปัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ:** ะะตัะบะพะปัะบะพ ะฟะพะปัะทะพะฒะฐัะตะปะตะน ะพะดะฝะพะฒัะตะผะตะฝะฝะพ
- **ะััะธัะพะฒะฐะฝะธะต:** ะะพะถะฝะพ ะดะพะฑะฐะฒะธัั ะบัั ัะฐััะธััะพะฒะพะบ (ะพะฟัะธะพะฝะฐะปัะฝะพ)

#### NFR-5: ะะพะดะดะตัะถะธะฒะฐะตะผะพััั
- **ะะพะบัะผะตะฝัะฐัะธั:** Docstrings ะฝะฐ ะฒัะตั ััะฝะบัะธัั
- **ะะพะณะธัะพะฒะฐะฝะธะต:** ะะตัะฐะปัะฝัะต ะปะพะณะธ ะฝะฐ ะบะฐะถะดะพะผ ััะฐะฟะต
- **ะขะตััะธััะตะผะพััั:** ะะพะทะผะพะถะฝะพััั ัะตััะธัะพะฒะฐัั ะพัะดะตะปัะฝัะต ะบะพะผะฟะพะฝะตะฝัั

---

## 4. ะขะะฅะะะงะะกะะะ ะฅะะะะะขะะะะกะขะะะ

### 4.1 ะขะตัะฝะพะปะพะณะธัะตัะบะธะน ััะตะบ

| ะะพะผะฟะพะฝะตะฝั | ะขะตัะฝะพะปะพะณะธั | ะะตััะธั | ะัะธะผะตัะฐะฝะธะต |
|-----------|-----------|--------|------------|
| ะคัะตะนะผะฒะพัะบ ะฑะพัะฐ | aiogram | 3.x | ะฃะถะต ะธัะฟะพะปัะทัะตััั |
| ะะฐััะธััะพะฒะบะฐ ะณะพะปะพัะฐ | OpenAI Whisper API | whisper-1 | Cloud API |
| HTTP ะบะปะธะตะฝั | httpx | async | ะฃะถะต ะธัะฟะพะปัะทัะตััั |
| ะะฑัะฐะฑะพัะบะฐ ะฐัะดะธะพ | ะัััะพะตะฝะฝัะน Telegram | - | Voice messages |
| ะะฅ LLM | OpenAI/Replicate | ัะตะบััะธะน | ะฃะถะต ะธัะฟะพะปัะทัะตััั |
| ะัะตะผะตะฝะฝัะต ัะฐะนะปั | pathlib + asyncio | - | ะัััะพะตะฝะฝัะน Python |

### 4.2 ะะฝะตัะฝะธะต ะทะฐะฒะธัะธะผะพััะธ

**ะขัะตะฑัะตะผัะต ัะตัะฒะธัั:**
1. **OpenAI API** - ะดะปั Whisper
   - API ะบะปัั ะดะพะปะถะตะฝ ะฑััั ะฒ ะบะพะฝัะธะณะต
   - ะะตััะธั: `OPENAI_API_KEY` (ัะถะต ะตััั)

2. **Telegram Bot API** - ะดะปั ัะบะฐัะธะฒะฐะฝะธั ัะฐะนะปะพะฒ
   - ะัะฟะพะปัะทัะตััั ัะตัะตะท aiogram.Bot.get_file()
   - ะฃะถะต ะฝะฐัััะพะตะฝะพ

### 4.3 ะะพะฝัะธะณััะฐัะธั

**ะะพะฑะฐะฒะธัั ะฒ `.env` / `config.py`:**
```python
# Whisper API
WHISPER_TIMEOUT = 60  # ัะตะบัะฝะดั
WHISPER_MODEL = "whisper-1"
WHISPER_LANGUAGE = None  # Auto-detect (None = ะฐะฒัะพ)

# ะัะตะผะตะฝะฝัะต ัะฐะนะปั
VOICE_TEMP_DIR = "data/temp/voice"  # ะะฐะฟะบะฐ ะดะปั ะณะพะปะพัะพะฒัั ัะฐะนะปะพะฒ
VOICE_MAX_SIZE = 20 * 1024 * 1024  # 20 MB - ะปะธะผะธั Telegram
```

---

## 5. ะกะขะะฃะะขะฃะะ ะะะะ

### 5.1 ะะพะฒัะต ัะฐะนะปั

```
app/
โโโ services/
โ   โโโ voice/
โ       โโโ __init__.py
โ       โโโ voice_processor.py      โ ะะปะฐะฒะฝัะน ะบะปะฐัั ะพะฑัะฐะฑะพัะบะธ ะณะพะปะพัะฐ
โ       โโโ whisper_client.py       โ ะะทะฐะธะผะพะดะตะนััะฒะธะต ั Whisper API
โ       โโโ voice_validator.py      โ ะะฐะปะธะดะฐัะธั ะณะพะปะพัะพะฒัั ัะฐะนะปะพะฒ
โ
โโโ handlers/
    โโโ voice.py                     โ ะะฑัะฐะฑะพััะธะบ voice messages ะฒ /chat
```

### 5.2 ะะทะผะตะฝัะตะผัะต ัะฐะนะปั

**app/handlers/chat.py**
- ะะพะฑะฐะฒะธัั ะพะฑัะฐะฑะพััะธะบ ะดะปั `@router.message(ChatStates.chatting, F.voice)`
- ะะฝัะตะณัะฐัะธั ั VoiceProcessor

**app/config.py** (ะธะปะธ settings)
- ะะพะฑะฐะฒะธัั ะฟะฐัะฐะผะตััั Whisper ะธ ะฒัะตะผะตะฝะฝัั ัะฐะนะปะพะฒ

**requirements.txt**
- ะะฐะฒะธัะธะผะพััะธ ัะถะต ะตััั (httpx, aiogram)

### 5.3 ะะพะดัะปะธ ะธ ะธั ะพัะฒะตัััะฒะตะฝะฝะพััั

#### **voice_processor.py** (ะะปะฐะฒะฝัะน ะพัะบะตัััะฐัะพั)
```python
class VoiceProcessor:
    """ะะฑัะฐะฑะพัะบะฐ ะณะพะปะพัะพะฒัั ัะพะพะฑัะตะฝะธะน ะฒ ัะตะถะธะผะต ะดะธะฐะปะพะณะฐ."""
    
    async def process_voice_message(
        self,
        message: Message,
        state: FSMContext,
        llm_factory: LLMFactory,
        prompt_manager: PromptManager
    ) -> None:
        """
        ะะพะปะฝัะน ัะธะบะป ะพะฑัะฐะฑะพัะบะธ ะณะพะปะพัะฐ:
        1. ะกะบะฐัะธะฒะฐะฝะธะต ัะฐะนะปะฐ
        2. ะะฐััะธััะพะฒะบะฐ Whisper
        3. ะะฑัะฐะฑะพัะบะฐ ัะตะบััะฐ ะบะฐะบ ะฒ ัะฐัะต
        4. ะัะฒะพะด ะพัะฒะตัะฐ
        """
```

#### **whisper_client.py** (API Whisper)
```python
class WhisperClient:
    """ะะทะฐะธะผะพะดะตะนััะฒะธะต ั OpenAI Whisper API."""
    
    async def transcribe_audio(
        self,
        file_path: Path,
        language: Optional[str] = None
    ) -> str:
        """
        ะะฐััะธััะพะฒะบะฐ ะฐัะดะธะพัะฐะนะปะฐ.
        
        Args:
            file_path: ะััั ะบ audio ัะฐะนะปั
            language: ะะพะด ัะทัะบะฐ (None = ะฐะฒัะพ)
            
        Returns:
            ะะฐััะธััะพะฒะฐะฝะฝัะน ัะตะบัั
            
        Raises:
            WhisperAPIError: ะัะธะฑะบะฐ API
            WhisperTimeoutError: ะขะฐะนะผะฐัั
        """
```

#### **voice_validator.py** (ะะฐะปะธะดะฐัะธั)
```python
class VoiceValidator:
    """ะะฐะปะธะดะฐัะธั ะณะพะปะพัะพะฒัั ัะฐะนะปะพะฒ ะฟะตัะตะด ะพะฑัะฐะฑะพัะบะพะน."""
    
    def validate_voice_message(self, voice: Voice) -> bool:
        """ะัะพะฒะตัะบะฐ ัะฐะทะผะตัะฐ, ัะพัะผะฐัะฐ, ะดะพัััะฟะฝะพััะธ."""
        
    def get_validation_error(self, voice: Voice) -> Optional[str]:
        """ะะพะทะฒัะฐั ัะตะบััะฐ ะพัะธะฑะบะธ ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั."""
```

---

## 6. ะะะะะะะขะะซ ะ ะะะะฆะะกะกะซ

### 6.1 ะัะฝะพะฒะฝะพะน ะฟัะพัะตัั ะพะฑัะฐะฑะพัะบะธ ะณะพะปะพัะฐ

```
ะจะะ 1: ะะพะปััะตะฝะธะต ะณะพะปะพัะพะฒะพะณะพ ัะพะพะฑัะตะฝะธั
โโ ะัะพะฒะตัะบะฐ ัะพััะพัะฝะธั: ChatStates.chatting โ
โโ ะะฐะปะธะดะฐัะธั: ัะฐะทะผะตั, ะดะพัััะฟะฝะพััั
โโ ะะพะณะธัะพะฒะฐะฝะธะต: "Voice message received"

ะจะะ 2: ะกะบะฐัะธะฒะฐะฝะธะต ัะฐะนะปะฐ ะธะท Telegram
โโ ะะพะปััะตะฝะธะต file_info: bot.get_file(voice.file_id)
โโ ะกะบะฐัะธะฒะฐะฝะธะต: bot.download_file(file_path)
โโ ะกะพััะฐะฝะตะฝะธะต ะฒะพ ะฒัะตะผะตะฝะฝัั ะฟะฐะฟะบั
โโ ะะพะณะธัะพะฒะฐะฝะธะต ัะฐะทะผะตัะฐ, ะฟััะธ

ะจะะ 3: ะัะฟัะฐะฒะบะฐ ะฒ Whisper API
โโ ะัะบัััะธะต ัะฐะนะปะฐ
โโ ะะพะดะณะพัะพะฒะบะฐ multipart/form-data
โโ POST ะทะฐะฟัะพั ะบ https://api.openai.com/v1/audio/transcriptions
โโ ะะฑัะฐะฑะพัะบะฐ ะพัะฒะตัะฐ
โโ ะะพะณะธัะพะฒะฐะฝะธะต: ััะฟะตั ะธะปะธ ะพัะธะฑะบะฐ

ะจะะ 4: ะะฑัะฐะฑะพัะบะฐ ัะฐััะธััะพะฒะบะธ
โโ ะัะพะฒะตัะบะฐ ะฝะฐ ะฟัััะพะน ัะตะบัั
โโ Trimming whitespace
โโ ะะพะณะธัะพะฒะฐะฝะธะต: "Transcribed: {text[:100]}..."

ะจะะ 5: ะะะะะะฏ ะพะฑัะฐะฑะพัะบะฐ ัะตะบััะฐ (ะบะฐะบ ะฒ chat.py)
โโ ะะฐะณััะทะบะฐ chat_system ะฟัะพะผะฟัะฐ
โโ ะะฐะฟัะพั ะฒ LLM
โโ ะะพะปััะตะฝะธะต ะพัะฒะตัะฐ
โโ Splitting ะฝะฐ ัะฐััะธ (4000 ัะธะผะฒะพะปะพะฒ)

ะจะะ 6: ะัะฒะพะด ัะตะทัะปััะฐัะฐ
โโ ะฃะดะฐะปะตะฝะธะต progress_msg
โโ ะัะฟัะฐะฒะบะฐ ะพัะฒะตัะฐ(ะพะฒ) ะฟะพะปัะทะพะฒะฐัะตะปั
โโ Markdown formatting
โโ ะะพะณะธัะพะฒะฐะฝะธะต: "Voice response sent"

ะจะะ 7: ะัะธััะบะฐ
โโ ะฃะดะฐะปะตะฝะธะต ะฒัะตะผะตะฝะฝะพะณะพ ัะฐะนะปะฐ
โโ ะะพะณะธัะพะฒะฐะฝะธะต
```

### 6.2 ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ

```
ะะจะะะะ: ะคะฐะนะป ัะปะธัะบะพะผ ะฑะพะปััะพะน
โ "โ๏ธ ะะพะปะพั ัะปะธัะบะพะผ ะดะปะธะฝะฝัะน (ะผะฐะบั 20 MB)"

ะะจะะะะ: Whisper API ะฝะตะดะพัััะฟะตะฝ
โ Retry 3 ัะฐะทะฐ ั ะธะฝัะตัะฒะฐะปะพะผ 2 ัะตะบ
โ "โ ะะต ัะดะฐะปะพัั ัะฐัะฟะพะทะฝะฐัั ะณะพะปะพั. ะะพะฟัะพะฑัะนัะต ัะตะบัั."

ะะจะะะะ: ะขะฐะนะผะฐัั ะฟัะธ ัะบะฐัะธะฒะฐะฝะธะธ
โ "โ ะัะธะฑะบะฐ ัะบะฐัะธะฒะฐะฝะธั. ะะพะถะฐะปัะนััะฐ ะฟะพะฟัะพะฑัะนัะต ัะฝะพะฒะฐ."

ะะจะะะะ: ะะฐัะฟะพะทะฝะฐะฝะฝัะน ัะตะบัั ะฟัััะพะน
โ "โ ะะต ัะดะฐะปะพัั ัะฐัะฟะพะทะฝะฐัั ัะตัั. ะะพะฒะพัะธัะต ะฑะพะปะตะต ะพััะตัะปะธะฒะพ."

ะะจะะะะ: ะัะธะฑะบะฐ LLM
โ ะกัะฐะฝะดะฐััะฝะฐั ะพะฑัะฐะฑะพัะบะฐ ะบะฐะบ ะฒ ัะฐัะต
```

---

## 7. ะะะขะะะะะฆะะฏ ะก ะกะฃะฉะะกะขะะฃะฎะฉะะ ะะะะะ

### 7.1 ะะทะผะตะฝะตะฝะธั ะฒ chat.py

**ะะพะฑะฐะฒะธัั ะฝะพะฒัะน ะพะฑัะฐะฑะพััะธะบ:**

```python
from app.services.voice.voice_processor import VoiceProcessor

@router.message(ChatStates.chatting, F.voice)
async def handle_voice_message(message: Message, state: FSMContext) -> None:
    """ะะฑัะฐะฑะพัะบะฐ ะณะพะปะพัะพะฒัั ัะพะพะฑัะตะฝะธะน ะฒ ัะตะถะธะผะต ัะฐัะฐ."""
    
    user_id = message.from_user.id
    
    # ะะพะบะฐะทะฐัั ะธะฝะดะธะบะฐัะพั ะฟะตัะฐัะธ
    await message.bot.send_chat_action(message.chat.id, "typing")
    
    # ะะพะบะฐะทะฐัั progress
    progress_msg = await message.answer(
        "๐๏ธ ะะฐัะฟะพะทะฝะฐั ัะตัั...",
        parse_mode="Markdown",
    )
    
    try:
        # ะะฝะธัะธะฐะปะธะทะธััะตะผ processor
        voice_processor = VoiceProcessor(
            openai_api_key=config.OPENAI_API_KEY,
            temp_dir=Path(config.VOICE_TEMP_DIR),
        )
        
        # ะะฑัะฐะฑะพัะบะฐ ะณะพะปะพัะฐ
        await voice_processor.process_voice_message(
            message=message,
            state=state,
            progress_msg=progress_msg,
            llm_factory=llm_factory,
            prompt_manager=prompt_manager,
        )
        
    except Exception as e:
        logger.error(f"Voice processing error: {e}")
        await progress_msg.delete()
        await message.answer(
            f"โ ะัะธะฑะบะฐ ะฟัะธ ะพะฑัะฐะฑะพัะบะต ะณะพะปะพัะฐ: {str(e)[:100]}"
        )
```

### 7.2 ะะตัะตะธัะฟะพะปัะทะพะฒะฐะฝะธะต ัััะตััะฒัััะตะณะพ ะบะพะดะฐ

**ะงัะพ ัะถะต ะตััั ะธ ะฟะตัะตะธัะฟะพะปัะทัะตะผ:**
- โ `LLMFactory` - ะดะปั ะทะฐะฟัะพัะพะฒ ะฒ ะะ
- โ `PromptManager` - ะดะปั ะทะฐะณััะทะบะธ chat_system ะฟัะพะผะฟัะฐ
- โ `TextSplitter` - ะดะปั ัะฐะทะฑะธะตะฝะธั ะพัะฒะตัะพะฒ
- โ ะะฑัะฐะฑะพัะบะฐ Markdown
- โ ะฃะฟัะฐะฒะปะตะฝะธะต ัะพััะพัะฝะธัะผะธ FSM

**ะงัะพ ัะพะทะดะฐัะผ ะฝะพะฒะพะต:**
- ๐ `VoiceProcessor` - ัะฟัะฐะฒะปะตะฝะธะต ะฟะพะปะฝัะผ ัะธะบะปะพะผ
- ๐ `WhisperClient` - ัะฐะฑะพัะฐ ั API
- ๐ `VoiceValidator` - ะฒะฐะปะธะดะฐัะธั ะฒัะพะดะฝัั ะดะฐะฝะฝัั

---

## 8. ะะะขะะะคะะะก ะ UX

### 8.1 ะะพะปัะทะพะฒะฐัะตะปััะบะธะน ะพะฟัั

**ะกัะตะฝะฐัะธะน 1: ะฃัะฟะตัะฝะพะต ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธะต**
```
๐ค ะะพะปัะทะพะฒะฐัะตะปั: [ะพัะฟัะฐะฒะปัะตั ะณะพะปะพั 5 ัะตะบ]

๐ค ะะพั: ๐๏ธ ะะฐัะฟะพะทะฝะฐั ัะตัั...
        โณ (ัะตัะตะท 10 ัะตะบ)
        
๐ค ะะพั: ๐ฌ ะะตะถะธะผ ะดะธะฐะปะพะณะฐ ะฐะบัะธะฒะตะฝ
        ะะธัะธัะต ะผะฝะต ัะฒะพะธ ะฒะพะฟัะพัั, ั ะณะพัะพะฒ ะฟะพะผะพัั!
        [ัะดะฐะปะตะฝะธะต ััะพะณะพ ัะพะพะฑัะตะฝะธั]
        
๐ค ะะพั: ๐ค ะัะผะฐั ะฝะฐะด ะฒะพะฟัะพัะพะผ...
        [ัะตัะตะท 5 ัะตะบ]
        
๐ค ะะพั: ะะพั ะผะพะน ะพัะฒะตั ะฝะฐ ะฒะฐั ะฒะพะฟัะพั...
```

**ะกัะตะฝะฐัะธะน 2: ะัะธะฑะบะฐ ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธั**
```
๐ค ะะพะปัะทะพะฒะฐัะตะปั: [ะพัะฟัะฐะฒะปัะตั ััะผ, ะฝะต ัะตัั]

๐ค ะะพั: ๐๏ธ ะะฐัะฟะพะทะฝะฐั ัะตัั...
        โณ (ัะตัะตะท 10 ัะตะบ)
        
๐ค ะะพั: โ ะะต ัะดะฐะปะพัั ัะฐัะฟะพะทะฝะฐัั ัะตัั. ะะพะฒะพัะธัะต ะฑะพะปะตะต ะพััะตัะปะธะฒะพ.
```

### 8.2 ะะฑัะฐะฑะพัะบะฐ UI

| ะญัะฐะฟ | ะกะพะพะฑัะตะฝะธะต | ะฃะดะฐะปัะตััั |
|------|-----------|----------|
| ะะพะปััะตะฝะธะต | "๐๏ธ ะะฐัะฟะพะทะฝะฐั ัะตัั..." | ะะตั, ะตัะปะธ ะพัะธะฑะบะฐ |
| ะะฐััะธััะพะฒะบะฐ | "๐๏ธ ะะฑัะฐะฑะฐััะฒะฐั..." | ะะฐ (ะฟะตัะตะด ะพัะฒะตัะพะผ) |
| ะะฑัะฐะฑะพัะบะฐ | "๐ค ะัะผะฐั..." | ะะฐ (ะฟะตัะตะด ะพัะฒะตัะพะผ) |
| ะัะฒะตั | ะัะฝะพะฒะฝะพะน ะพัะฒะตั | ะะตั |

---

## 9. ะขะะกะขะะะะะะะะ

### 9.1 ะฎะฝะธั-ัะตััั

**test_voice_validator.py**
- ะขะตัั ะฒะฐะปะธะดะฐัะธะธ ัะฐะทะผะตัะฐ ัะฐะนะปะฐ
- ะขะตัั ะฒะฐะปะธะดะฐัะธะธ ัะพัะผะฐัะฐ
- ะขะตัั ะพัะธะฑะพะบ ะฒะฐะปะธะดะฐัะธะธ

**test_whisper_client.py**
- ะขะตัั ัะฐััะธััะพะฒะบะธ (mock)
- ะขะตัั ะพะฑัะฐะฑะพัะบะธ ะพัะธะฑะพะบ API
- ะขะตัั retry logic

**test_voice_processor.py**
- ะขะตัั ะฟะพะปะฝะพะณะพ ัะธะบะปะฐ (mock)
- ะขะตัั ะธะฝัะตะณัะฐัะธะธ ั LLM
- ะขะตัั ะพะฑัะฐะฑะพัะบะธ ะพัะธะฑะพะบ

### 9.2 ะะฝัะตะณัะฐัะธะพะฝะฝัะต ัะตััั

**test_voice_integration.py**
- ะะตะฐะปัะฝะพะต ะณะพะปะพัะพะฒะพะต ัะพะพะฑัะตะฝะธะต ะฒ Telegram
- ะัะพะฒะตัะบะฐ ัะฐััะธััะพะฒะบะธ
- ะัะพะฒะตัะบะฐ ะพัะฒะตัะฐ ะะ
- ะัะพะฒะตัะบะฐ ัะพัะผะฐัะธัะพะฒะฐะฝะธั

### 9.3 ะััะฝะพะต ัะตััะธัะพะฒะฐะฝะธะต

**ะงะตะบ-ะปะธัั ะฒ Telegram:**

- [ ] /chat ะฐะบัะธะฒะตะฝ
- [ ] ะัะฟัะฐะฒะธัั 5-ัะตะบัะฝะดะฝัะน ะณะพะปะพั
- [ ] ะัะพะฒะตัะธัั ัะฐััะธััะพะฒะบั
- [ ] ะัะพะฒะตัะธัั ะพัะฒะตั ะะ
- [ ] ะัะพะฒะตัะธัั ัะพัะผะฐัะธัะพะฒะฐะฝะธะต
- [ ] ะัะฟัะฐะฒะธัั ะณะพะปะพั ะฝะฐ ััััะบะพะผ
- [ ] ะัะฟัะฐะฒะธัั ะณะพะปะพั ะฝะฐ ะฐะฝะณะปะธะนัะบะพะผ
- [ ] ะัะฟัะฐะฒะธัั ััะผ (ะพัะธะฑะบะฐ)
- [ ] ะัะฟัะฐะฒะธัั ะพัะตะฝั ะดะปะธะฝะฝัะน ะณะพะปะพั
- [ ] ะัะฟัะฐะฒะธัั ะฟัะธ ะพัะบะปัััะฝะฝะพะผ ะธะฝัะตัะฝะตัะต

---

## 10. ะะะะะะะกะะะกะขะฌ ะ ะะะะะะขะะะกะขะฌ

### 10.1 ะะตะทะพะฟะฐัะฝะพััั ะดะฐะฝะฝัั

**ะะพะปะพัะพะฒัะต ัะฐะนะปั:**
- โ ะกะพััะฐะฝััััั ะฒะพ ะฒัะตะผะตะฝะฝัั ะฟะฐะฟะบั
- โ ะฃะดะฐะปััััั ะฟะพัะปะต ะพะฑัะฐะฑะพัะบะธ
- โ ะะต ะปะพะณะธัััััั ัะพะดะตัะถะธะผะพะต

**ะขะตะบัั ัะฐััะธััะพะฒะบะธ:**
- โ ะะตัะตะดะฐะตััั ัะพะปัะบะพ ะฒ Whisper API ะธ LLM
- โ ะะต ัะพััะฐะฝัะตััั ะฝะฐ ะดะธัะบ
- โ ะะพะณะธััะตััั ัะพะปัะบะพ ะฟะตัะฒัะต 100 ัะธะผะฒะพะปะพะฒ

### 10.2 ะะฑัะฐะฑะพัะบะฐ ะพัะธะฑะพะบ ะฑะตะทะพะฟะฐัะฝะพััะธ

**ะงัะพ ะตัะปะธ API ะบะปัั ัะบะพะผะฟัะพะผะตัะธัะพะฒะฐะฝ:**
- Whisper ะบะปัั = ะพัะฝะพะฒะฝะพะน OPENAI_API_KEY
- ะะฐัะธัะฐ: ะธัะฟะพะปัะทัะตััั ัะพะบะตะฝ-ะปะธะผะธั ะฝะฐ OpenAI
- ะะตะบะพะผะตะฝะดะฐัะธั: ะพัะดะตะปัะฝัะน API ะบะปัั ะดะปั Whisper (ะพะฟัะธะพะฝะฐะปัะฝะพ)

**ะงัะพ ะตัะปะธ ะณะพะปะพั ัะพะดะตัะถะธั ะบะพะฝัะธะดะตะฝัะธะฐะปัะฝัั ะธะฝัะพัะผะฐัะธั:**
- ะะพะปัะทะพะฒะฐัะตะปั ะพัะฒะตัะฐะตั ะทะฐ ะบะพะฝัะธะดะตะฝัะธะฐะปัะฝะพััั
- ะคะฐะนะป ัะดะฐะปัะตััั ะผะณะฝะพะฒะตะฝะฝะพ
- ะะพะณะธัะพะฒะฐะฝะธะต ะฝะต ัะพะดะตัะถะธั ะดะฐะฝะฝัั

---

## 11. ะะะะะะะขะซะะะะะ ะ ะะะะคะะะฃะะะฆะะฏ

### 11.1 ะัะตะดััะปะพะฒะธั

```bash
# ะขัะตะฑัะตะผะพะต
โ OpenAI API ะบะปัั (OPENAI_API_KEY ะฒ config)
โ Python 3.9+
โ aiogram 3.x
โ httpx (async)

# ะะฟัะธะพะฝะฐะปัะฝะพะต
โ๏ธ ะัะดะตะปัะฝัะน Whisper API ะบะปัั (ะตัะปะธ ัะพัะตััั ัะฐะทะดะตะปะธัั ะปะธะผะธัั)
```

### 11.2 ะฃััะฐะฝะพะฒะบะฐ ะทะฐะฒะธัะธะผะพััะตะน

```bash
# ะะฐะฒะธัะธะผะพััะธ ัะถะต ะดะพะปะถะฝั ะฑััั (httpx, aiogram)
pip install -r requirements.txt

# ะกะพะทะดะฐัั ะฟะฐะฟะบั ะดะปั ะฒัะตะผะตะฝะฝัั ัะฐะนะปะพะฒ
mkdir -p data/temp/voice
```

### 11.3 ะะพะฝัะธะณััะฐัะธั

**ะ ัะฐะนะปะต config.py / .env:**

```python
# Whisper
WHISPER_TIMEOUT = 60  # ัะตะบัะฝะดั
WHISPER_MODEL = "whisper-1"
WHISPER_LANGUAGE = None  # auto-detect

# ะัะตะผะตะฝะฝัะต ัะฐะนะปั
VOICE_TEMP_DIR = "data/temp/voice"
VOICE_MAX_SIZE = 20 * 1024 * 1024  # 20 MB
VOICE_RETENTION_TIME = 300  # ะฃะดะฐะปะธัั ัะฐะนะป ัะตัะตะท 5 ะผะธะฝัั
```

### 11.4 ะัะพะฒะตัะบะฐ ะฟะพัะปะต ัะฐะทะฒะตัััะฒะฐะฝะธั

```bash
# 1. ะัะพะฒะตัะธัั ะบะพะฝัะธะณ
python -c "from app.config import get_settings; c = get_settings(); print('Whisper:', c.OPENAI_API_KEY is not None)"

# 2. ะัะพะฒะตัะธัั ะฟะฐะฟะบั
ls -la data/temp/voice/

# 3. ะะฐะฟัััะธัั ะฑะพัะฐ
python main.py

# 4. ะัะพัะตััะธัะพะฒะฐัั ะฒ Telegram
/chat โ ะพัะฟัะฐะฒะธัั ะณะพะปะพั
```

---

## 12. ะะะะะขะะะะะ ะ ะะะะะะะะะะะ

### 12.1 ะะพะณะธัะพะฒะฐะฝะธะต

**ะฃัะพะฒะตะฝั DEBUG:**
```
DEBUG - Voice file received: 12345_voice.ogg (150 KB)
DEBUG - Downloaded to: data/temp/voice/uuid.ogg
DEBUG - Sending to Whisper API...
DEBUG - Whisper response: OK
DEBUG - Transcribed: "ะัะธะฒะตั, ะบะฐะบ ะดะตะปะฐ?" (15 chars)
```

**ะฃัะพะฒะตะฝั INFO:**
```
INFO - Voice processing started for user 123
INFO - Transcription completed: 15 chars
INFO - LLM response: 250 chars
INFO - Voice processing completed for user 123
```

**ะฃัะพะฒะตะฝั ERROR:**
```
ERROR - Whisper API error: 429 Too Many Requests
ERROR - Voice processing failed: Connection timeout
ERROR - File too large: 25 MB > 20 MB limit
```

### 12.2 ะะตััะธะบะธ

**ะงัะพ ะพััะปะตะถะธะฒะฐัั:**
- ะะพะปะธัะตััะฒะพ ะพะฑัะฐะฑะพัะฐะฝะฝัั ะณะพะปะพัะพะฒัั ัะพะพะฑัะตะฝะธะน
- ะกัะตะดะฝะตะต ะฒัะตะผั ัะฐััะธััะพะฒะบะธ
- ะัะพัะตะฝั ััะฟะตัะฝัั ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธะน
- ะกัะตะดะฝะตะต ะฒัะตะผั ะพะฑัะฐะฑะพัะบะธ ะะ

---

## 13. ะะะะะะะงะะะะฏ ะ ะะะะะกะขะะซะ ะะะะะะะะซ

### 13.1 ะะณัะฐะฝะธัะตะฝะธั Whisper API

| ะะณัะฐะฝะธัะตะฝะธะต | ะะฝะฐัะตะฝะธะต | ะะตัะตะฝะธะต |
|------------|---------|----------|
| ะะฐะทะผะตั ัะฐะนะปะฐ | 25 MB | ะัะพะฒะตััะตะผ ะฟะตัะตะด ะพัะฟัะฐะฒะบะพะน |
| ะขะฐะนะผะฐัั | 60 ัะตะบ | ะะพะณะธััะตะผ ะธ ัะฒะตะดะพะผะปัะตะผ |
| RateLimit | 3 req/min (free) | Retry ั backoff |
| ะฏะทัะบะธ | 99+ | Auto-detect ัะฐะฑะพัะฐะตั |

### 13.2 ะะทะฒะตััะฝัะต ะฟัะพะฑะปะตะผั

**ะัะพะฑะปะตะผะฐ:** ะะปะพัะพะต ัะฐัะฟะพะทะฝะฐะฒะฐะฝะธะต ะฒ ััะผะฝัั ะผะตััะฐั  
**ะัะธัะธะฝะฐ:** ะะณัะฐะฝะธัะตะฝะธะต Whisper  
**ะะตัะตะฝะธะต:** ะะพะบัะผะตะฝัะฐัะธั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั

**ะัะพะฑะปะตะผะฐ:** ะะปะธะฝะฝัะต ะณะพะปะพัะพะฒัะต ัะพะพะฑัะตะฝะธั ะผะตะดะปะตะฝะฝะพ ะพะฑัะฐะฑะฐััะฒะฐัััั  
**ะัะธัะธะฝะฐ:** ะขะตะปะตะณัะฐะผ API, Whisper API  
**ะะตัะตะฝะธะต:** ะะฐัะฐะปะปะตะปัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ, ะฝะพ max 1 ะฝะฐ ะฟะพะปัะทะพะฒะฐัะตะปั

---

## 14. ะะฃะะฃะฉะะ ะะะกะจะะะะะะฏ

**ะะพัะปะต ะพัะฝะพะฒะฝะพะน ัะตะฐะปะธะทะฐัะธะธ (ะพะฟัะธะพะฝะฐะปัะฝะพ):**

1. **ะััะธัะพะฒะฐะฝะธะต ัะฐััะธััะพะฒะพะบ**
   - ะะดะธะฝะฐะบะพะฒัะต ะณะพะปะพัะฐ ะฝะต ััะตะฑััั ะฟะตัะตััะตัะฐ
   - Redis ะธะปะธ ะปะพะบะฐะปัะฝะฐั ะะ

2. **ะะพะปะพัะพะฒัะต ะพัะฒะตัั**
   - Text-to-Speech (TTS) ะดะปั ะพัะฒะตัะพะฒ ะะ
   - Telegram Voice Message

3. **ะกัะฐัะธััะธะบะฐ**
   - ะงัะพ ัะฟัะฐัะธะฒะฐะปะธ ะฟะพะปัะทะพะฒะฐัะตะปะธ
   - ะะพะฟัะปััะฝัะต ะฒะพะฟัะพัั
   - ะะตััะธะบะธ

4. **ะะฟัะธะผะธะทะฐัะธั**
   - ะกะถะฐัะธะต ะฐัะดะธะพ ะฟะตัะตะด ะพัะฟัะฐะฒะบะพะน
   - ะะพะบะฐะปัะฝะฐั ะผะพะดะตะปั Whisper (offline)

---

## 15. ะะะะขะะะะ ะะะะะะะ

### 15.1 ะคัะฝะบัะธะพะฝะฐะปัะฝะพััั

- โ ะะพะปะพัะพะฒัะต ัะพะพะฑัะตะฝะธั ะฟัะธะฝะธะผะฐัััั ะฒ `/chat`
- โ ะะฐััะธััะพะฒะบะฐ ัะฐะฑะพัะฐะตั ะดะปั ััััะบะพะณะพ ัะทัะบะฐ
- โ ะะฐััะธััะพะฒะบะฐ ัะฐะฑะพัะฐะตั ะดะปั ะฐะฝะณะปะธะนัะบะพะณะพ ัะทัะบะฐ
- โ ะะฐััะธััะพะฒะฐะฝะฝัะน ัะตะบัั ะพะฑัะฐะฑะฐััะฒะฐะตััั ะบะฐะบ ะฒ ัะฐัะต
- โ ะัะฒะตั ะพัะฟัะฐะฒะปัะตััั ะฒ ัะฐั
- โ ะคะพัะผะฐัะธัะพะฒะฐะฝะธะต ัะพััะฐะฝะตะฝะพ
- โ ะะปะธะฝะฝัะต ะพัะฒะตัั ัะฐะทะฑะธะฒะฐัััั ะบะพััะตะบัะฝะพ

### 15.2 ะะฐะดะตะถะฝะพััั

- โ ะะฑัะฐะฑะพัะบะฐ ะฒัะตั ะพัะธะฑะพะบ (API, ัะตัั, timeout)
- โ Graceful degradation ะฟัะธ ะพัะธะฑะบะต
- โ ะะพะณะธัะพะฒะฐะฝะธะต ะฒัะตั ััะฐะฟะพะฒ
- โ ะัะตะผะตะฝะฝัะต ัะฐะนะปั ัะดะฐะปััััั

### 15.3 ะัะพะธะทะฒะพะดะธัะตะปัะฝะพััั

- โ ะัะตะผั ะพะฑัะฐะฑะพัะบะธ < 30 ัะตะบ ะดะปั 60-ัะตะบ ะณะพะปะพัะฐ
- โ ะะฐัะฐะปะปะตะปัะฝะฐั ะพะฑัะฐะฑะพัะบะฐ ะฝะตัะบะพะปัะบะธั ะฟะพะปัะทะพะฒะฐัะตะปะตะน
- โ ะะตั ััะตัะตะบ ะฟะฐะผััะธ

### 15.4 ะะฐัะตััะฒะพ ะบะพะดะฐ

- โ PEP8 compliance
- โ Type hints ะฝะฐ ะฒัะตั ััะฝะบัะธัั
- โ Docstrings ะฝะฐ ะฒัะตั ะผะพะดัะปัั
- โ ะะตั hardcoded ะทะฝะฐัะตะฝะธะน
- โ ะัะฟะพะปัะทะพะฒะฐะฝะธะต ะบะพะฝัะธะณััะฐัะธะธ

---

## 16. ะะะะะะะะะะฏ

### 16.1 API Whisper ะฟัะธะผะตั

```bash
curl -X POST https://api.openai.com/v1/audio/transcriptions \
  -H "Authorization: Bearer $OPENAI_API_KEY" \
  -F "file=@audio.mp3" \
  -F "model=whisper-1" \
  -F "language=ru"

# ะัะฒะตั:
{
  "text": "ะัะธะฒะตั, ะบะฐะบ ะดะตะปะฐ?"
}
```

### 16.2 ะกัััะบัััะฐ ะฒัะตะผะตะฝะฝะพะน ะฟะฐะฟะบะธ

```
data/
โโโ temp/
    โโโ voice/
        โโโ user_123_uuid1.ogg  (10 MB)
        โโโ user_456_uuid2.ogg  (5 MB)
        โโโ user_123_uuid3.ogg  (8 MB)
```

### 16.3 ะัะธะผะตั ะปะพะณะฐ

```
2025-12-20 20:30:45 INFO  - Voice processing started for user 7884972750
2025-12-20 20:30:46 DEBUG - Voice file: 12345.ogg (150 KB)
2025-12-20 20:30:46 DEBUG - Downloaded to: data/temp/voice/uuid.ogg
2025-12-20 20:30:48 DEBUG - Sending to Whisper API...
2025-12-20 20:31:02 INFO  - Transcribed: "ะัะธะฒะตั, ะบะฐะบ ะดะตะปะฐ?" (15 chars)
2025-12-20 20:31:03 DEBUG - Loading chat_system prompt for user
2025-12-20 20:31:05 DEBUG - LLM request: ะัะธะฒะตั! ะะฐะบ ั ะฒะฐั ะดะตะปะฐ?...
2025-12-20 20:31:10 INFO  - LLM response: 250 chars in 5 parts
2025-12-20 20:31:11 DEBUG - Voice response sent
2025-12-20 20:31:11 INFO  - Voice processing completed for user
```

---

## ะะะะฎะะ

**ะงัะพ ะดะตะปะฐะตะผ:**
ะะพะฑะฐะฒะปัะตะผ ะณะพะปะพัะพะฒะพะน ะฒะฒะพะด ะฒ ัะตะถะธะผ ะดะธะฐะปะพะณะฐ ัะตัะตะท OpenAI Whisper API.

**ะะฐะบ ัะฐะฑะพัะฐะตั:**
```
ะะพะปะพั โ ะกะบะฐัะธะฒะฐะฝะธะต โ Whisper โ ะขะตะบัั โ LLM โ ะัะฒะตั โ ะงะฐั
```

**ะะปััะตะฒัะต ะบะพะผะฟะพะฝะตะฝัั:**
- `VoiceProcessor` - ะณะปะฐะฒะฝัะน ะพัะบะตัััะฐัะพั
- `WhisperClient` - ัะฐะฑะพัะฐ ั API
- `VoiceValidator` - ะฒะฐะปะธะดะฐัะธั
- ะะฑัะฐะฑะพััะธะบ ะฒ `chat.py`

**ะะตะทัะปััะฐั:**
ะะพะปัะทะพะฒะฐัะตะปั ะผะพะถะตั ะพัะฟัะฐะฒะปััั ะณะพะปะพั ะฒ `/chat`, ะธ ะฑะพั ะฑัะดะตั ะตะณะพ ะพะฑัะฐะฑะฐััะฒะฐัั ะบะฐะบ ัะตะบััะพะฒัะน ะฒะฒะพะด.

**ะกัะพะบะธ:** 3-4 ัะฐัะฐ ัะฐะทัะฐะฑะพัะบะธ  
**ะกะปะพะถะฝะพััั:** ะกัะตะดะฝัั  
**ะะธัะบะธ:** ะะฐะฒะธัะธะผะพััั ะพั OpenAI API  

---

*ะะพะบัะผะตะฝั ะฒะตััะธะธ 1.0*  
*ะะฐัะฐ: 2025-12-20*  
*ะกัะฐััั: ะ ัะฐะทัะฐะฑะพัะบะต*
