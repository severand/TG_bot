# üìã –¢–ï–•–ù–ò–ß–ï–°–ö–û–ï –ó–ê–î–ê–ù–ò–ï: RAG KNOWLEDGE BASE

**–î–∞—Ç–∞:** 21.12.2025  
**–í–µ—Ä—Å–∏—è:** 1.0  
**–°—Ç–∞—Ç—É—Å:** DRAFT - –¢—Ä–µ–±—É–µ—Ç —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è

---

## üéØ –¶–ï–õ–¨ –ü–†–û–ï–ö–¢–ê

–°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ–ª–ª–µ–∫—Ç—É–∞–ª—å–Ω—É—é —Å–∏—Å—Ç–µ–º—É –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π —Å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–º –ø–æ–∏—Å–∫–æ–º –∏ –∞–Ω–∞–ª–∏–∑–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ LLM —Å –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º—ã–º–∏ –ø—Ä–æ–º–ø—Ç–∞–º–∏.

**–ö–ª—é—á–µ–≤–æ–µ –æ—Ç–ª–∏—á–∏–µ –æ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –∫–æ–º–∞–Ω–¥:**
- `/analyze` - –æ–¥–Ω–æ—Ä–∞–∑–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑ –¥–æ–∫—É–º–µ–Ω—Ç–∞ —Å –ø—Ä–æ–º–ø—Ç–æ–º (–¥–æ–∫—É–º–µ–Ω—Ç –ù–ï —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è)
- `/homework` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ–º–∞—à–Ω–∏—Ö –∑–∞–¥–∞–Ω–∏–π –ø–æ –ø—Ä–µ–¥–º–µ—Ç–∞–º (—Å–ø–µ—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è)
- **`/rag`** - –Ω–∞–∫–æ–ø–ª–µ–Ω–∏–µ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π + —É–º–Ω—ã–π –ø–æ–∏—Å–∫ + –∞–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ LLM —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏

---

## üë§ USER STORIES

### US-1: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π
**–ö–∞–∫** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å  
**–Ø —Ö–æ—á—É** –∑–∞–≥—Ä—É–∂–∞—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π  
**–ß—Ç–æ–±—ã** –ø–æ—Ç–æ–º –∏—Å–∫–∞—Ç—å –ø–æ –Ω–∏–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é

**Acceptance Criteria:**
- [ ] –ö–æ–º–∞–Ω–¥–∞ `/rag` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é RAG
- [ ] –ö–Ω–æ–ø–∫–∞ "üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç"
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª (PDF, DOCX, DOC, TXT, Excel, ZIP)
- [ ] –°–∏—Å—Ç–µ–º–∞ –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç
- [ ] –°–∏—Å—Ç–µ–º–∞ —Ä–∞–∑–±–∏–≤–∞–µ—Ç –Ω–∞ chunks (—Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã)
- [ ] –°–∏—Å—Ç–µ–º–∞ —Å–æ–∑–¥–∞—ë—Ç embeddings
- [ ] –°–∏—Å—Ç–µ–º–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: "‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω! –§—Ä–∞–≥–º–µ–Ω—Ç–æ–≤: N"
- [ ] –ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

### US-2: –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
**–ö–∞–∫** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å  
**–Ø —Ö–æ—á—É** –≤–∏–¥–µ—Ç—å —á—Ç–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ –≤ –º–æ—é –±–∞–∑—É  
**–ß—Ç–æ–±—ã** –ø–æ–Ω–∏–º–∞—Ç—å –∫–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –¥–æ—Å—Ç—É–ø–Ω—ã –¥–ª—è –ø–æ–∏—Å–∫–∞

**Acceptance Criteria:**
- [ ] –ö–Ω–æ–ø–∫–∞ "üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞"
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
  - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
  - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
  - –°–ø–∏—Å–æ–∫ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
- [ ] –ö–Ω–æ–ø–∫–∞ "üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –±–∞–∑—É" –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –≤—Å–µ—Ö –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤

---

### US-3: –£–º–Ω—ã–π –ø–æ–∏—Å–∫ —Å –≤—ã–±–æ—Ä–æ–º –ø—Ä–æ–º–ø—Ç–∞ –∏ –∞–Ω–∞–ª–∏–∑–æ–º —á–µ—Ä–µ–∑ LLM
**–ö–∞–∫** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å  
**–Ø —Ö–æ—á—É** –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ –º–æ–∏–º –¥–æ–∫—É–º–µ–Ω—Ç–∞–º –∏ –ø–æ–ª—É—á–∏—Ç—å —É–º–Ω—ã–π –æ—Ç–≤–µ—Ç —á–µ—Ä–µ–∑ LLM  
**–ß—Ç–æ–±—ã** –±—ã—Å—Ç—Ä–æ –Ω–∞—Ö–æ–¥–∏—Ç—å –Ω—É–∂–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å –∏–Ω—Ç–µ—Ä–ø—Ä–µ—Ç–∞—Ü–∏–µ–π

**Acceptance Criteria:**
- [ ] –ö–Ω–æ–ø–∫–∞ "üîç –ü–æ–∏—Å–∫"
- [ ] **–®–ê–ì 1:** –°–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –ø—Ä–æ–º–ø—Ç–æ–≤ (–∫–∞–∫ –≤ `/analyze`)
  - –ü—Ä–æ–º–ø—Ç—ã –∏–∑ PromptManager
  - –¢–æ–ª—å–∫–æ document prompts (–Ω–µ homework)
  - –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞
- [ ] **–®–ê–ì 2:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–º–ø—Ç
- [ ] **–®–ê–ì 3:** –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –≤–æ–ø—Ä–æ—Å/–∑–∞–ø—Ä–æ—Å
- [ ] **–®–ê–ì 4:** –°–∏—Å—Ç–µ–º–∞:
  1. –°–æ–∑–¥–∞—ë—Ç embedding –∑–∞–ø—Ä–æ—Å–∞
  2. –ò—â–µ—Ç —Ç–æ–ø-5 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ (cosine similarity)
  3. –§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
  4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ LLM: system_prompt (–∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞) + –∫–æ–Ω—Ç–µ–∫—Å—Ç + –≤–æ–ø—Ä–æ—Å
  5. –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç LLM
- [ ] **–®–ê–ì 5:** –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç:
  ```
  ü§ñ –û—Ç–≤–µ—Ç:
  [–æ—Ç–≤–µ—Ç LLM]
  
  üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:
  ‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç: file.pdf (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: 87%)
  ‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç: contract.docx (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: 65%)
  ```
- [ ] –ö–Ω–æ–ø–∫–∞ "üîç –ù–æ–≤—ã–π –ø–æ–∏—Å–∫" –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞

---

### US-4: –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –±–µ–∑ –ø—Ä–æ–º–ø—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
**–ö–∞–∫** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å  
**–Ø —Ö–æ—á—É** –±—ã—Å—Ç—Ä–æ –Ω–∞–π—Ç–∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã –±–µ–∑ –∞–Ω–∞–ª–∏–∑–∞ —á–µ—Ä–µ–∑ LLM  
**–ß—Ç–æ–±—ã** –ø—Ä–æ—Å—Ç–æ —É–≤–∏–¥–µ—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ –∫—É—Å–∫–∏ —Ç–µ–∫—Å—Ç–∞

**Acceptance Criteria:**
- [ ] –ö–Ω–æ–ø–∫–∞ "‚ö° –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫" (–≤ –¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –∫ "üîç –ü–æ–∏—Å–∫")
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–∏—à–µ—Ç –∑–∞–ø—Ä–æ—Å
- [ ] –°–∏—Å—Ç–µ–º–∞ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ç–æ–ø-3 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ —Å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é
- [ ] –ë–ï–ó –∞–Ω–∞–ª–∏–∑–∞ —á–µ—Ä–µ–∑ LLM (—ç–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤)

---

### US-5: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
**–ö–∞–∫** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å  
**–Ø —Ö–æ—á—É** –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç—ã –≤ —á–∞—Ç –∏ –æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ø–∞–¥–∞—é—Ç –≤ RAG  
**–ß—Ç–æ–±—ã** –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—å—Å—è –≤ —Ä–µ–∂–∏–º `/rag`

**Acceptance Criteria:**
- [ ] –ù–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ `/rag_auto on` - –≤–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é
- [ ] –ù–æ–≤–∞—è –∫–æ–º–∞–Ω–¥–∞ `/rag_auto off` - –≤—ã–∫–ª—é—á–∏—Ç—å
- [ ] –ö–æ–≥–¥–∞ –≤–∫–ª—é—á–µ–Ω–æ:
  - –õ—é–±–æ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è –≤ RAG
  - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è: "‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω –≤ –±–∞–∑—É –∑–Ω–∞–Ω–∏–π"
  - –î–æ–∫—É–º–µ–Ω—Ç –ù–ï –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è —Å—Ä–∞–∑—É (—Ç–æ–ª—å–∫–æ –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è)
- [ ] –°–æ—Å—Ç–æ—è–Ω–∏–µ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

---

## üèóÔ∏è –ê–†–•–ò–¢–ï–ö–¢–£–†–ê

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã —Å–∏—Å—Ç–µ–º—ã

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Telegram Bot                         ‚îÇ
‚îÇ                   /rag command                          ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              RAG Handler (app/handlers/rag.py)          ‚îÇ
‚îÇ  - Menu management                                      ‚îÇ
‚îÇ  - User interaction flow                                ‚îÇ
‚îÇ  - State management (RAGStates)                         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         PromptManager Integration                        ‚îÇ
‚îÇ  - Load user prompts                                    ‚îÇ
‚îÇ  - Filter document prompts                              ‚îÇ
‚îÇ  - Provide system_prompt for LLM                        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ            RAG Module (rag_knowledge_base/)             ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  FileConverter - Extract text from files        ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  Chunker - Split text into chunks               ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  EmbeddingService - Generate embeddings         ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ  In-Memory Storage - Store user documents       ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                  ‚îÇ
                  ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ              LLM Factory (app/services/llm/)            ‚îÇ
‚îÇ  - OpenAI / Replicate                                   ‚îÇ
‚îÇ  - Fallback mechanism                                   ‚îÇ
‚îÇ  - Streaming support                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîÑ –§–õ–û–£ –†–ê–ë–û–¢–´

### –§–õ–û–£ 1: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞

```
User: /rag
  ‚Üì
Bot: –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é RAG
  ‚Üì
User: –ù–∞–∂–∏–º–∞–µ—Ç "üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å"
  ‚Üì
Bot: "–û—Ç–ø—Ä–∞–≤—å—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç"
  ‚Üì
User: –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∞–π–ª (contract.pdf)
  ‚Üì
Bot: 
  1. –ò–∑–≤–ª–µ–∫–∞–µ—Ç —Ç–µ–∫—Å—Ç (FileConverter)
  2. –†–∞–∑–±–∏–≤–∞–µ—Ç –Ω–∞ chunks (Chunker)
  3. –°–æ–∑–¥–∞—ë—Ç embeddings (EmbeddingService)
  4. –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ storage[user_id]
  ‚Üì
Bot: "‚úÖ –î–æ–∫—É–º–µ–Ω—Ç –¥–æ–±–∞–≤–ª–µ–Ω! –§—Ä–∞–≥–º–µ–Ω—Ç–æ–≤: 15"
```

---

### –§–õ–û–£ 2: –£–º–Ω—ã–π –ø–æ–∏—Å–∫ —Å –ø—Ä–æ–º–ø—Ç–æ–º

```
User: /rag ‚Üí "üîç –ü–æ–∏—Å–∫"
  ‚Üì
Bot: –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–º–ø—Ç–æ–≤:
  ‚Ä¢ üìÑ –ê–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞
  ‚Ä¢ üíº –ë–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏–∑
  ‚Ä¢ üìä –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
  ‚Ä¢ ‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç
  ‚Üì
User: –í—ã–±–∏—Ä–∞–µ—Ç "üìÑ –ê–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞"
  ‚Üì
Bot: "üí¨ –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å –ø–æ –¥–æ–∫—É–º–µ–Ω—Ç–∞–º"
  ‚Üì
User: "–ö–∞–∫–∏–µ —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã?"
  ‚Üì
Bot:
  1. –°–æ–∑–¥–∞—ë—Ç embedding –≤–æ–ø—Ä–æ—Å–∞
  2. –ò—â–µ—Ç —Ç–æ–ø-5 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö chunks (cosine similarity)
  3. –§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç:
     Context = chunk1 + chunk2 + chunk3 + ...
  4. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –≤ LLM:
     System: [system_prompt –∏–∑ "–ê–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞"]
     User: Context: [–Ω–∞–π–¥–µ–Ω–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã]
            Question: –ö–∞–∫–∏–µ —É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã?
  5. –ü–æ–ª—É—á–∞–µ—Ç –æ—Ç–≤–µ—Ç –æ—Ç LLM
  ‚Üì
Bot: 
  ü§ñ –û—Ç–≤–µ—Ç:
  [–¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç LLM –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞]
  
  üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:
  ‚Ä¢ contract.pdf (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: 87%)
  ‚Ä¢ terms.docx (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: 65%)
  
  [üîç –ù–æ–≤—ã–π –ø–æ–∏—Å–∫] [¬´ –ù–∞–∑–∞–¥]
```

---

### –§–õ–û–£ 3: –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ (–±–µ–∑ LLM)

```
User: /rag ‚Üí "‚ö° –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫"
  ‚Üì
Bot: "üí¨ –ù–∞–ø–∏—à–∏—Ç–µ –∑–∞–ø—Ä–æ—Å"
  ‚Üì
User: "—É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã"
  ‚Üì
Bot:
  1. –°–æ–∑–¥–∞—ë—Ç embedding –∑–∞–ø—Ä–æ—Å–∞
  2. –ò—â–µ—Ç —Ç–æ–ø-3 —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö chunks
  3. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –Ω–∞–ø—Ä—è–º—É—é (–ë–ï–ó LLM)
  ‚Üì
Bot:
  üîç –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞: "—É—Å–ª–æ–≤–∏—è –æ–ø–ª–∞—Ç—ã"
  
  üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç 1 (87%)
  üìÑ –ò—Å—Ç–æ—á–Ω–∏–∫: contract.pdf
  üí¨ "–û–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ 30 –¥–Ω–µ–π..."
  
  üìå –†–µ–∑—É–ª—å—Ç–∞—Ç 2 (65%)
  üìÑ –ò—Å—Ç–æ—á–Ω–∏–∫: terms.docx
  üí¨ "–í–æ–∑–º–æ–∂–Ω–∞ –ø—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ 50% –æ—Ç —Å—É–º–º—ã..."
  
  [‚ö° –ù–æ–≤—ã–π –ø–æ–∏—Å–∫] [¬´ –ù–∞–∑–∞–¥]
```

---

## üóÑÔ∏è –°–¢–†–£–ö–¢–£–†–ê –î–ê–ù–ù–´–•

### In-Memory Storage

```python
document_storage: Dict[int, List[Dict]] = {}

# –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
{
  user_id: [
    {
      'text': str,           # –¢–µ–∫—Å—Ç chunk
      'embedding': np.ndarray,  # –í–µ–∫—Ç–æ—Ä 384D
      'filename': str,       # –ò–º—è —Ñ–∞–π–ª–∞
      'position': int,       # –ü–æ–∑–∏—Ü–∏—è chunk –≤ –¥–æ–∫—É–º–µ–Ω—Ç–µ
      'metadata': Dict       # –î–æ–ø. –¥–∞–Ω–Ω—ã–µ
    },
    ...
  ]
}
```

### User Settings (–Ω–æ–≤–∞—è —Ç–∞–±–ª–∏—Ü–∞ –≤ –ë–î)

```python
# app/models/user_settings.py
class UserSettings:
    user_id: int
    rag_auto_index: bool = False  # –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è
    default_rag_prompt: Optional[str] = None  # –ü—Ä–æ–º–ø—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
```

---

## üé® UI/UX –¢–†–ï–ë–û–í–ê–ù–ò–Ø

### –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é RAG

```
üß† RAG Knowledge Base

–£–º–Ω–∞—è –±–∞–∑–∞ –∑–Ω–∞–Ω–∏–π —Å —Å–µ–º–∞–Ω—Ç–∏—á–µ—Å–∫–∏–º –ø–æ–∏—Å–∫–æ–º.

üìä –°—Ç–∞—Ç—É—Å:
‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç–æ–≤: 3
‚Ä¢ –§—Ä–∞–≥–º–µ–Ω—Ç–æ–≤: 45

üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤:
–ù–∞–∂–º–∏—Ç–µ '–ó–∞–≥—Ä—É–∑–∏—Ç—å', –∑–∞—Ç–µ–º –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª

üîç –ü–æ–∏—Å–∫:
–ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã –Ω–∞ –µ—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω–æ–º —è–∑—ã–∫–µ

üëá –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:

[üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å] [üîç –ü–æ–∏—Å–∫]
[‚ö° –ë—ã—Å—Ç—Ä—ã–π] [üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞]
[üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å] [¬´ –ù–∞–∑–∞–¥]
```

### –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –ø—Ä–æ–º–ø—Ç–∞

```
üîç –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –∞–Ω–∞–ª–∏–∑–∞:

üìÑ –ê–Ω–∞–ª–∏–∑ –¥–æ–≥–æ–≤–æ—Ä–∞
–î–µ—Ç–∞–ª—å–Ω—ã–π —Ä–∞–∑–±–æ—Ä —É—Å–ª–æ–≤–∏–π, –ø—Ä–∞–≤ –∏ –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç–µ–π

üíº –ë–∏–∑–Ω–µ—Å-–∞–Ω–∞–ª–∏–∑
–û—Ü–µ–Ω–∫–∞ –±–∏–∑–Ω–µ—Å-–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π –∏ —Ä–∏—Å–∫–æ–≤

üìä –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –∞–Ω–∞–ª–∏–∑
–ê–Ω–∞–ª–∏–∑ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –ø–æ–∫–∞–∑–∞—Ç–µ–ª–µ–π

[‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–º–ø—Ç]
[¬´ –ù–∞–∑–∞–¥]
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞

```
ü§ñ –û—Ç–≤–µ—Ç:

[–î–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç LLM –Ω–∞ –æ—Å–Ω–æ–≤–µ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤]

üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:
  ‚Ä¢ contract.pdf (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: 87%)
    "–û–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ..."
  
  ‚Ä¢ terms.docx (—Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: 65%)
    "–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞ —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 50%..."

[üîç –ù–æ–≤—ã–π –ø–æ–∏—Å–∫] [¬´ –ù–∞–∑–∞–¥]
```

---

## ‚öôÔ∏è –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–Ø

### States (app/states/rag.py)

```python
class RAGStates(StatesGroup):
    main_menu = State()
    uploading = State()
    selecting_prompt = State()      # –ù–û–í–´–ô!
    searching_with_llm = State()    # –ù–û–í–´–ô!
    searching_quick = State()       # –ù–û–í–´–ô!
```

### –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å PromptManager

```python
# –í app/handlers/rag.py

# –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø—Ä–æ–º–ø—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
prompt_manager = PromptManager()
prompt_manager.load_user_prompts(user_id)

# –ü–æ–ª—É—á–∏—Ç—å —Ç–æ–ª—å–∫–æ document prompts
doc_prompts = [
    p for p in prompt_manager.list_prompts(user_id)
    if p.type == PromptType.DOCUMENT
]

# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç
selected_prompt = prompt_manager.get_prompt(user_id, prompt_name)
system_prompt = selected_prompt.system_prompt
```

### LLM Request Format

```python
# –§–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–ø—Ä–æ—Å–∞ –∫ LLM

context = "\n\n---\n\n".join([
    f"[–î–æ–∫—É–º–µ–Ω—Ç: {chunk['filename']}]\n{chunk['text']}"
    for chunk in top_chunks
])

user_message = f"""
Context –∏–∑ –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π:

{context}

---

–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {user_query}

–ù–∞ –æ—Å–Ω–æ–≤–µ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞, –æ—Ç–≤–µ—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
"""

# –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ LLM
response = await llm_factory.analyze_document(
    document_text=user_message,
    analysis_prompt="",  # –£–∂–µ –≤–∫–ª—é—á—ë–Ω –≤ user_message
    system_prompt=selected_prompt.system_prompt,
    use_streaming=True
)
```

### –ú–µ—Ç—Ä–∏–∫–∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏

```python
# Cosine similarity threshold
MIN_RELEVANCE = 0.3  # 30%

# –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ chunks –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
TOP_K_CHUNKS = 5

# –≠–º–æ–¥–∑–∏ –ø–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏
def get_relevance_emoji(score: float) -> str:
    if score > 0.7:
        return "üéØ"  # –û—Ç–ª–∏—á–Ω–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å
    elif score > 0.5:
        return "üìå"  # –•–æ—Ä–æ—à–∞—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å
    else:
        return "üìÑ"  # –°—Ä–µ–¥–Ω—è—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å
```

---

## üöÄ –≠–¢–ê–ü–´ –†–ê–ó–†–ê–ë–û–¢–ö–ò

### Phase 1: –ë–∞–∑–æ–≤–∞—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏ ‚úÖ PRIORITY
- [ ] –î–æ–±–∞–≤–∏—Ç—å `selecting_prompt` state
- [ ] –ü–æ—Å–ª–µ "üîç –ü–æ–∏—Å–∫" –ø–æ–∫–∞–∑—ã–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–º–ø—Ç–æ–≤
- [ ] –°–æ—Ö—Ä–∞–Ω—è—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –ø—Ä–æ–º–ø—Ç –≤ state
- [ ] –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å system_prompt –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞

### Phase 2: LLM –∞–Ω–∞–ª–∏–∑ —Å –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º ‚úÖ PRIORITY
- [ ] –§–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –∫–æ–Ω—Ç–µ–∫—Å—Ç –∏–∑ —Ç–æ–ø-5 chunks
- [ ] –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –≤ LLM: system_prompt + context + query
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å streaming –¥–ª—è –æ—Ç–≤–µ—Ç–∞ LLM

### Phase 3: –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –î–æ–±–∞–≤–∏—Ç—å "‚ö° –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫"
- [ ] –ü–æ–∫–∞–∑—ã–≤–∞—Ç—å —Ç–æ–ø-3 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞ –±–µ–∑ LLM
- [ ] –≠–∫–æ–Ω–æ–º–∏—è —Ç–æ–∫–µ–Ω–æ–≤

### Phase 4: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è
- [ ] –ö–æ–º–∞–Ω–¥–∞ `/rag_auto on/off`
- [ ] –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ë–î
- [ ] –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ –≤ —á–∞—Ç–µ

### Phase 5: –£–ª—É—á—à–µ–Ω–∏—è UX
- [ ] –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ
- [ ] –ö–Ω–æ–ø–∫–∞ "–°–æ–∑–¥–∞—Ç—å –ø—Ä–æ–º–ø—Ç" –ø—Ä—è–º–æ –∏–∑ RAG
- [ ] –ò—Å—Ç–æ—Ä–∏—è –ø–æ–∏—Å–∫–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- [ ] –≠–∫—Å–ø–æ—Ä—Ç –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤

---

## üìä –ú–ï–¢–†–ò–ö–ò –£–°–ü–ï–•–ê

- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –º–æ–∂–µ—Ç –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç –∑–∞ 3 –∫–ª–∏–∫–∞
- [ ] –ü–æ–∏—Å–∫ —Å LLM –∑–∞–Ω–∏–º–∞–µ—Ç < 30 —Å–µ–∫—É–Ω–¥
- [ ] –†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ > 60%
- [ ] –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–Ω–∏–º–∞–µ—Ç –æ—Ç–∫—É–¥–∞ –≤–∑—è—Ç –æ—Ç–≤–µ—Ç (–∏—Å—Ç–æ—á–Ω–∏–∫–∏ –ø–æ–∫–∞–∑–∞–Ω—ã)
- [ ] –ú–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ª—é–±–æ–π –ø—Ä–æ–º–ø—Ç –∏–∑ PromptManager

---

## ‚ùì –í–û–ü–†–û–°–´ –î–õ–Ø –û–ë–°–£–ñ–î–ï–ù–ò–Ø

1. **–•—Ä–∞–Ω–∏–ª–∏—â–µ:** –û—Å—Ç–∞–≤–∏—Ç—å in-memory –∏–ª–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –Ω–∞ PostgreSQL/ChromaDB?
2. **–†–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:** –¢–æ–ø-5 chunks –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∏–ª–∏ –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ?
3. **–°—Ç–æ–∏–º–æ—Å—Ç—å:** Streaming –æ—Ç LLM –∏–ª–∏ –æ–±—ã—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å?
4. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è:** –ù—É–∂–Ω–∞ –ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è (`/rag_auto`)?
5. **UI:** –ù—É–∂–µ–Ω –ª–∏ –±—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –±–µ–∑ LLM –∏–ª–∏ —Ç–æ–ª—å–∫–æ —É–º–Ω—ã–π –ø–æ–∏—Å–∫?

---

## üìù –°–¢–ê–¢–£–°

**–¢–µ–∫—É—â–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è (BAD):**
- ‚úÖ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚úÖ –ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –∏ embeddings —Ä–∞–±–æ—Ç–∞—é—Ç
- ‚úÖ –ë–∞–∑–æ–≤—ã–π –ø–æ–∏—Å–∫ –ø–æ similarity —Ä–∞–±–æ—Ç–∞–µ—Ç
- ‚ùå –ù–ï–¢ –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å –ø—Ä–æ–º–ø—Ç–∞–º–∏
- ‚ùå –ù–ï–¢ –∞–Ω–∞–ª–∏–∑–∞ —á–µ—Ä–µ–∑ LLM
- ‚ùå –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —Å—ã—Ä—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã

**–¢—Ä–µ–±—É–µ—Ç—Å—è (GOOD):**
- ‚úÖ –í—Å—ë —á—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç —Å–µ–π—á–∞—Å
- üî• –í—ã–±–æ—Ä –ø—Ä–æ–º–ø—Ç–∞ –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º
- üî• –ê–Ω–∞–ª–∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ LLM
- üî• –£–º–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –≤–º–µ—Å—Ç–æ —Å—ã—Ä—ã—Ö –∫—É—Å–∫–æ–≤ —Ç–µ–∫—Å—Ç–∞

---

## ‚úÖ ACCEPTANCE CRITERIA –ü–†–û–ï–ö–¢–ê

–ü—Ä–æ–µ–∫—Ç —Å—á–∏—Ç–∞–µ—Ç—Å—è –∑–∞–≤–µ—Ä—à—ë–Ω–Ω—ã–º –∫–æ–≥–¥–∞:

1. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–≥—Ä—É–∂–∞–µ—Ç –¥–æ–∫—É–º–µ–Ω—Ç ‚Üí –¥–æ–∫—É–º–µ–Ω—Ç –∏–Ω–¥–µ–∫—Å–∏—Ä—É–µ—Ç—Å—è
2. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∂–º—ë—Ç "üîç –ü–æ–∏—Å–∫" ‚Üí –≤–∏–¥–∏—Ç —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–º–ø—Ç–æ–≤
3. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±–∏—Ä–∞–µ—Ç –ø—Ä–æ–º–ø—Ç ‚Üí –ø–∏—à–µ—Ç –≤–æ–ø—Ä–æ—Å
4. ‚úÖ –°–∏—Å—Ç–µ–º–∞ –Ω–∞—Ö–æ–¥–∏—Ç —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã
5. ‚úÖ –°–∏—Å—Ç–µ–º–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã + –≤–æ–ø—Ä–æ—Å –≤ LLM —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º –ø—Ä–æ–º–ø—Ç–æ–º
6. ‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–æ–ª—É—á–∞–µ—Ç —É–º–Ω—ã–π –æ—Ç–≤–µ—Ç –æ—Ç LLM
7. ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∏—Å—Ç–æ—á–Ω–∏–∫–∏ (–¥–æ–∫—É–º–µ–Ω—Ç—ã —Å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é)
8. ‚úÖ –ú–æ–∂–Ω–æ –¥–µ–ª–∞—Ç—å –Ω–æ–≤—ã–π –ø–æ–∏—Å–∫ –±–µ–∑ –≤—ã—Ö–æ–¥–∞ –∏–∑ RAG

---

## üìå –ü–†–ò–û–†–ò–¢–ï–¢–´

### üî• –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ï (–¥–µ–ª–∞—Ç—å –ü–ï–†–í–´–ú–ò):
1. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å PromptManager (–≤—ã–±–æ—Ä –ø—Ä–æ–º–ø—Ç–∞)
2. LLM –∞–Ω–∞–ª–∏–∑ –Ω–∞–π–¥–µ–Ω–Ω—ã—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
3. –ü–æ–∫–∞–∑ –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å—é

### üü° –°–†–ï–î–ù–ò–ï (–¥–µ–ª–∞—Ç—å –í–¢–û–†–´–ú–ò):
1. –ë—ã—Å—Ç—Ä—ã–π –ø–æ–∏—Å–∫ –±–µ–∑ LLM
2. –£–ª—É—á—à–µ–Ω–∏–µ UX (streaming, –ø—Ä–æ–≥—Ä–µ—Å—Å)
3. –ö–Ω–æ–ø–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ–º–ø—Ç–∞ –∏–∑ RAG

### üü¢ –ù–ò–ó–ö–ò–ï (–¥–µ–ª–∞—Ç—å –ü–û–°–õ–ï–î–ù–ò–ú–ò):
1. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—è `/rag_auto`
2. –ò—Å—Ç–æ—Ä–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤
3. –≠–∫—Å–ø–æ—Ä—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
4. –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ ChromaDB

---

**–ö–æ–Ω–µ—Ü –¥–æ–∫—É–º–µ–Ω—Ç–∞**